CREATE TABLE "Дилеры" (
    "ИД_Дилера" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Процент" DECIMAL(5,2),
    "Комментарии" TEXT
);

CREATE TABLE "Менеджеры" (
    "ИД_Менеджера" SERIAL PRIMARY KEY,
    "ИД_Дилера" INT REFERENCES "Дилеры"("ИД_Дилера"),
    "Имя" VARCHAR(100),
    "Процент" DECIMAL(5,2),
    "Дата_найма" DATE,
    "Комментарии" TEXT,
    "ИД_Родителя" INT
);

CREATE TABLE "Контрагенты" (
    "ИД_Контрагента" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Адрес" VARCHAR(255),
    "Телефон" VARCHAR(20),
    "Комментарии" TEXT
);

CREATE TABLE "Контракты" (
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    PRIMARY KEY ("ИД_Контрагента", "ИД_Менеджера")
);

CREATE TABLE "Банки" (
    "ИД_Банка" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Адрес" VARCHAR(255)
);

CREATE TABLE "Группы" (
    "ИД_Группы" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Комментарии" TEXT
);

CREATE TABLE "Товары" (
    "ИД_Товара" SERIAL PRIMARY KEY,
    "ИД_Группы" INT REFERENCES "Группы"("ИД_Группы"),
    "Название" VARCHAR(100),
    "Описание" TEXT,
    "Срок_годности" INT
);

CREATE TABLE "Валюты" (
    "ИД_Валюты" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Сокращение" VARCHAR(10)
);

CREATE TABLE "Цены" (
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    "ИД_Валюты" INT REFERENCES "Валюты"("ИД_Валюты"),
    "Значение" DECIMAL(10,2),
    PRIMARY KEY ("ИД_Товара", "Дата_Начала", "ИД_Валюты")
);


CREATE TABLE "Курсы" (
    "ИД_Валюты_От" INT REFERENCES "Валюты"("ИД_Валюты"),
    "ИД_Валюты_К" INT REFERENCES "Валюты"("ИД_Валюты"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    "Значение" DECIMAL(10,2),
    PRIMARY KEY ("ИД_Валюты_От", "ИД_Валюты_К", "Дата_Начала")
);

CREATE TABLE "Налоги" (
    "ИД_Налога" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Значение" DECIMAL(5,2),
    "Комментарии" TEXT
);

CREATE TABLE "Сделки_Покупки" (
    "ИД_Сделки" SERIAL PRIMARY KEY,
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата" DATE,
    "Количество" INT,
    "Стоимость" DECIMAL(10,2),
    "ИД_Налога" INT REFERENCES "Налоги"("ИД_Налога")
);

CREATE TABLE "Сделки_Продажи" (
    "ИД_Сделки" SERIAL PRIMARY KEY,
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата" DATE,
    "Количество" INT,
    "Стоимость" DECIMAL(10,2),
    "ИД_Налога" INT REFERENCES "Налоги"("ИД_Налога")
);

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 1', 5.00, 'Комментарий о дилере 1'),
('Дилер 2', 6.00, 'Комментарий о дилере 2'),
('Дилер 3', 7.00, 'Комментарий о дилере 3'),
('Дилер 4', 8.00, 'Комментарий о дилере 4'),
('Дилер 5', 9.00, 'Комментарий о дилере 5');

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 6', 5.00, 'Комментарий о дилере 6'),
('Дилер 7', 4.50, 'Комментарий о дилере 7'),
('Дилер 8', 6.00, 'Комментарий о дилере 8');

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 9', 3.00, 'Комментарий о дилере 9'),
('Дилер 10', 2.50, 'Комментарий о дилере 10'),
('Дилер 11', 4.00, 'Комментарий о дилере 11');

INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(1, 'Менеджер 1', 10.00, '2024-01-01', 'Комментарий о менеджере 1', NULL),
(1, 'Менеджер 2', 11.00, '2024-02-01', 'Комментарий о менеджере 2', NULL),
(2, 'Менеджер 3', 12.00, '2024-03-01', 'Комментарий о менеджере 3', NULL),
(3, 'Менеджер 4', 13.00, '2024-04-01', 'Комментарий о менеджере 4', NULL),
(4, 'Менеджер 5', 14.00, '2024-05-01', 'Комментарий о менеджере 5', NULL);

INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(6, 'Менеджер 1', 12.00, '2024-05-01', 'Комментарий о менеджере 6', 1),
(7, 'Менеджер 2', 10.00, '2024-05-02', 'Комментарий о менеджере 7', 3),
(8, 'Менеджер 3', 7.00, '2024-05-02', 'Комментарий о менеджере 8', 4);

INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(9, 'Менеджер 1', 4.00, '2024-05-03', 'Комментарий о менеджере 9', 3),
(10, 'Менеджер 2', 3.75, '2024-05-03', 'Комментарий о менеджере 10', 3),
(11, 'Менеджер 3', 2.30, '2024-05-03', 'Комментарий о менеджере 11', 4);

INSERT INTO "Контрагенты" ("Название", "Адрес", "Телефон", "Комментарии") VALUES
('Контрагент 1', 'Адрес контрагента 1', '111-111', 'Комментарий о контрагенте 1'),
('Контрагент 2', 'Адрес контрагента 2', '222-222', 'Комментарий о контрагенте 2'),
('Контрагент 3', 'Адрес контрагента 3', '333-333', 'Комментарий о контрагенте 3'),
('Контрагент 4', 'Адрес контрагента 4', '444-444', 'Комментарий о контрагенте 4');

INSERT INTO "Контракты" ("ИД_Контрагента", "ИД_Менеджера", "Дата_Начала", "Дата_Окончания") VALUES
(1, 1, '2024-01-01', '2024-12-31'),
(2, 2, '2024-02-01', '2024-12-31'),
(3, 3, '2024-03-01', '2024-12-31'),
(4, 4, '2024-04-01', '2024-12-31');

INSERT INTO "Банки" ("Название", "Адрес") VALUES
('Банк 1', 'Адрес банка 1'),
('Банк 2', 'Адрес банка 2'),
('Банк 3', 'Адрес банка 3');

INSERT INTO "Группы" ("Название", "Комментарии") VALUES
('Группа 1', 'Комментарий о группе 1'),
('Группа 2', 'Комментарий о группе 2'),
('Группа 3', 'Комментарий о группе 3');

INSERT INTO "Валюты" ("Название", "Сокращение") VALUES
('Рубли', 'RUB'),
('Доллары', 'USD'),
('Евро', 'EUR');

INSERT INTO "Товары" ("ИД_Группы", "Название", "Описание", "Срок_годности") VALUES
(1, 'Товар 1', 'Описание товара 1', 365),
(2, 'Товар 2', 'Описание товара 2', 180),
(3, 'Товар 3', 'Описание товара 3', 90),
(1, 'Товар 4', 'Описание товара 4', 365),
(2, 'Товар 5', 'Описание товара 5', 180),
(3, 'Товар 6', 'Описание товара 6', 90),
(1, 'Товар 7', 'Описание товара 7', 365),
(2, 'Товар 8', 'Описание товара 8', 180),
(3, 'Товар 9', 'Описание товара 9', 90),
(1, 'Товар 10', 'Описание товара 10', 365),
(2, 'Товар 11', 'Описание товара 11', 180),
(3, 'Товар 12', 'Описание товара 12', 90),
(1, 'Товар 13', 'Описание товара 13', 365),
(2, 'Товар 14', 'Описание товара 14', 180),
(3, 'Товар 15', 'Описание товара 15', 90);

INSERT INTO "Цены" ("ИД_Товара", "Дата_Начала", "Дата_Окончания", "ИД_Валюты", "Значение") VALUES
(1, '2024-01-01', '2024-12-31', 1, 100),
(2, '2024-01-01', '2024-12-31', 1, 200),
(3, '2024-01-01', '2024-12-31', 1, 300),
(4, '2024-01-01', '2024-12-31', 1, 400),
(5, '2024-01-01', '2024-12-31', 1, 500),
(6, '2024-01-01', '2024-12-31', 1, 600),
(7, '2024-01-01', '2024-12-31', 1, 700),
(8, '2024-01-01', '2024-12-31', 1, 800),
(9, '2024-01-01', '2024-12-31', 1, 900),
(10, '2024-01-01', '2024-12-31', 1, 1000),
(11, '2024-01-01', '2024-12-31', 1, 1100),
(12, '2024-01-01', '2024-12-31', 1, 1200),
(13, '2024-01-01', '2024-12-31', 1, 1300),
(14, '2024-01-01', '2024-12-31', 1, 1400),
(15, '2024-01-01', '2024-12-31', 1, 1500);

INSERT INTO "Курсы" ("ИД_Валюты_От", "ИД_Валюты_К", "Дата_Начала", "Дата_Окончания", "Значение") VALUES
(1, 2, '2024-01-01', '2024-12-31', 0.013), -- Курс рубля к доллару
(1, 3, '2024-01-01', '2024-12-31', 0.012); -- Курс рубля к евро

ALTER TABLE "Контракты"
ADD CONSTRAINT "FK_Контракты_Менеджеры"
FOREIGN KEY ("ИД_Менеджера")
REFERENCES "Менеджеры" ("ИД_Менеджера");
----------------------------------------------------------------------------------------------
INSERT INTO "Товары" ("ИД_Группы", "Название", "Описание", "Срок_годности") VALUES
(4, 'Товар 51', 'Описание товара 51', 600),
(5, 'Товар 52', 'Описание товара 52', 250),
(6, 'Товар 53', 'Описание товара 53', 35),
(4, 'Товар 61', 'Описание товара 61', 90),
(5, 'Товар 62', 'Описание товара 62', 120),
(6, 'Товар 63', 'Описание товара 63', 500);

INSERT INTO "Товары" ("ИД_Группы", "Название", "Описание", "Срок_годности") VALUES
(1, 'Товар 55', 'Описание товара 55', 100),
(3, 'Товар 65', 'Описание товара 65', 150),
(4, 'Товар 75', 'Описание товара 75', 350);

INSERT INTO "Группы" ("Название", "Комментарии") VALUES
('Группа 10', 'Комментарий о группе 10'),
('Группа 13', 'Комментарий о группе 13'),
('Группа 15', 'Комментарий о группе 15');

INSERT INTO "Цены" ("ИД_Товара", "Дата_Начала", "Дата_Окончания", "ИД_Валюты", "Значение") VALUES
(16, '2024-02-05', '2025-10-05', 1, 10000),
(17, '2024-03-24', '2025-08-24', 2, 200),
(18, '2024-07-03', '2025-12-03', 3, 230),
(19, '2024-08-25', '2025-01-25', 1, 40000),
(20, '2024-09-04', '2024-02-04', 2, 550),
(21, '2024-09-10', '2025-02-10', 3, 1000);

INSERT INTO "Цены" ("ИД_Товара", "Дата_Начала", "Дата_Окончания", "ИД_Валюты", "Значение") VALUES
(22, '2024-09-11', '2025-10-11', 1, 30000),
(23, '2024-09-11', '2025-08-11', 1, 40000),
(24, '2024-09-12', '2025-12-12', 2, 2000);

INSERT INTO "Налоги" ("Название", "Значение", "Комментарии") VALUES
('Налог 1', 13.00, 'Комментарий к налогу 1'),
('Налог 2', 10.55, 'Комментарий к налогу 2'),
('Налог 3', 15.85, 'Комментарий к налогу 3');

INSERT INTO "Сделки_Покупки" ("ИД_Товара", "ИД_Контрагента",
                              "ИД_Менеджера", "Дата", "Количество",
                              "Стоимость", "ИД_Налога") VALUES
(1, 1, 1, '2023-01-03', 5, 1000, 1),
(2, 2, 3, '2023-02-09', 10, 100, 2),
(3, 3, 4, '2023-02-15', 12, 200, 3),
(4, 4, 2, '2023-04-25', 55, 30, 2),
(5, 1, 8, '2023-04-26', 20, 12, 3),
(6, 2, 9, '2023-06-01', 9, 81, 1),
(7, 2, 10, '2023-06-02', 5, 42, 1),
(8, 4, 3, '2023-07-01', 2, 5, 1),
(9, 1, 1, '2023-07-07', 5, 1000, 1),
(10, 2, 3, '2023-09-05', 10, 100, 2),
(11, 3, 4, '2023-10-17', 12, 200, 3),
(12, 4, 2, '2023-11-20', 55, 30, 2),
(13, 1, 8, '2023-01-03', 20, 12, 3),
(14, 2, 7, '2024-02-04', 9, 81, 1),
(15, 2, 10, '2024-03-15', 5, 42, 1),
(16, 4, 6, '2024-04-13', 2, 5, 1),
(17, 1, 1, '2024-05-25', 5, 1000, 1),
(18, 2, 5, '2024-06-24', 10, 100, 2),
(19, 3, 4, '2024-07-12', 12, 200, 3),
(20, 4, 2, '2024-08-03', 55, 30, 2),
(21, 1, 8, '2024-09-05', 20, 12, 3);

INSERT INTO "Сделки_Покупки" ("ИД_Товара", "ИД_Контрагента",
                              "ИД_Менеджера", "Дата", "Количество",
                              "Стоимость", "ИД_Налога") VALUES
(22, 1, 1, '2023-09-05', 11, 100, 1),
(23, 2, 3, '2023-09-05', 4, 300, 1),
(24, 3, 4, '2023-09-06', 3, 400, 2);

UPDATE "Сделки_Покупки"
SET "Дата" = CASE
    WHEN "Дата" = '2023-09-05' THEN '2024-09-05'
    WHEN "Дата" = '2023-09-06' THEN '2024-09-06'
    ELSE "Дата"
END
WHERE "Дата" IN ('2023-09-05', '2023-09-06');


-- Явные курсоры
-- 10.1
-- Явный курсор, возвращающий список всех товаров (id, название товара, название
-- группы товара, стоимость в рублях на дату поступления), поступивших в текущем месяце,
-- чья цена задана в рублях;

DO $$
DECLARE
    rec RECORD;
    cur CURSOR FOR
    SELECT
        "Товары"."ИД_Товара",
        "Товары" ."Название" AS "Название_Товара",
        "Группы"."Название" AS "Название_Группы",
        "Цены"."Значение" AS "Стоимость_В_Рублях"
    FROM
        "Товары"
    JOIN
        "Группы" ON "Товары"."ИД_Группы" = "Группы"."ИД_Группы"
    JOIN
        "Цены"  ON "Товары"."ИД_Товара" = "Цены"."ИД_Товара"
    WHERE
        "Цены"."ИД_Валюты" = 1
        AND "Цены"."Дата_Начала" <= CURRENT_DATE
        AND "Цены"."Дата_Окончания" >= CURRENT_DATE;
BEGIN
    OPEN cur;
    LOOP
        FETCH cur INTO rec;
        EXIT WHEN NOT FOUND;
        RAISE NOTICE 'ID: %, Название товара: %, Название группы: %, Стоимость в рублях: %',
            rec."ИД_Товара", rec."Название_Товара", rec."Название_Группы", rec."Стоимость_В_Рублях";
    END LOOP;
    CLOSE cur;
END $$;

-- 10.2
-- Явный курсор с входными параметрами месяц и валюта, возвращающих список
-- (id, название товаров, название группы товаров, стоимость в рублях
-- на дату поступления) всех товаров, чья стоимость в заданной валюте,
-- поступивших в заданном месяце текущего года


DO $$
    DECLARE
        rec RECORD;
        cur CURSOR (month INT, currency_id INT) FOR
        SELECT
            "Товары"."ИД_Товара",
            "Товары"."Название" AS "Название_Товара",
            "Группы"."Название" AS "Название_Группы",
            "Цены"."Значение" AS "Стоимость_В_Рублях"
        FROM
            "Товары"
        JOIN
            "Группы" ON "Товары"."ИД_Группы" = "Группы"."ИД_Группы"
        JOIN
            "Цены" ON "Цены"."ИД_Товара" = "Товары"."ИД_Товара"
        JOIN
            "Сделки_Покупки" ON  "Сделки_Покупки"."ИД_Товара" = "Товары"."ИД_Товара"
        WHERE
            "Цены"."ИД_Валюты" = currency_id
            AND EXTRACT(MONTH FROM "Сделки_Покупки"."Дата") = month
            AND EXTRACT(YEAR FROM "Сделки_Покупки"."Дата") = EXTRACT(YEAR FROM CURRENT_DATE)
            AND "Цены"."Дата_Начала" <= CURRENT_DATE
            AND "Цены"."Дата_Окончания" >= CURRENT_DATE;
    BEGIN
        -- Пример вызова курсора с параметрами: месяц = 9 (сентябрь), валюта = 1 (рубль)
        OPEN cur(9, 1);

        LOOP
            FETCH cur INTO rec;
            EXIT WHEN NOT FOUND;
            RAISE NOTICE 'ID: %, Название товара: %, Название группы: %, Стоимость в рублях: %',
                    rec."ИД_Товара", rec."Название_Товара", rec."Название_Группы", rec."Стоимость_В_Рублях";
        END LOOP;

        CLOSE cur;
END $$;



-- Неявные курсоры
-- 10.1 Написать неявный курсор, возвращающий объем  всех товаров  поступивших
-- в текущем месяце, чья цена задана в рублях;



-- 10.2 Написать неявный курсор для указанных месяца и  валюты, повышающий
-- стоимость на 5% для товаров, поступивших в указанной валюте и в заданном
-- месяце текущего года. Сообщить, если вообще не было поступлений в
-- указанный период или не было поступлений в указанной валюте.


--Неявные курсоры
--13.1
DO $$
DECLARE
    m INTEGER;
BEGIN
    SELECT COUNT(ca."ИД_Контрагента") INTO m
    FROM "Контрагенты" ca
    JOIN "Контракты" c ON c."ИД_Контрагента" = ca."ИД_Контрагента"
    WHERE c."Дата_Начала" >= current_date - INTERVAL '6 months';

    RAISE NOTICE 'кол-во контрагентов = %', m;
END $$;


--13.2
DO $$
DECLARE
    c_id INTEGER;
    start_date DATE;
    end_date DATE;
    contract_duration INTERVAL;
    min_duration INTERVAL := INTERVAL '6 months';
    target_year INTEGER := 2023;
BEGIN
    FOR c_id, start_date, end_date IN
        SELECT c."ИД_Контрагента", c."Дата_Начала", c."Дата_Окончания"
        FROM "Контракты" c
        WHERE EXTRACT(YEAR FROM c."Дата_Начала") = target_year
    LOOP
        contract_duration := end_date - start_date;

        if contract_duration >= min_duration then
            update "Контрагенты"
            set "Комментарии" = 'Контракт продолжительности ' || contract_duration
            where "ИД_Контрагента" = c_id;
        end if;
    end loop;
END $$;









