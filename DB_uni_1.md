CREATE TABLE "Дилеры" (
    "ИД_Дилера" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Процент" DECIMAL(5,2),
    "Комментарии" TEXT
);

CREATE TABLE "Менеджеры" (
    "ИД_Менеджера" SERIAL PRIMARY KEY,
    "ИД_Дилера" INT REFERENCES "Дилеры"("ИД_Дилера"),
    "Имя" VARCHAR(100),
    "Процент" DECIMAL(5,2),
    "Дата_найма" DATE,
    "Комментарии" TEXT,
    "ИД_Родителя" INT
);

CREATE TABLE "Контрагенты" (
    "ИД_Контрагента" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Адрес" VARCHAR(255),
    "Телефон" VARCHAR(20),
    "Комментарии" TEXT
);

CREATE TABLE "Контракты" (
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    PRIMARY KEY ("ИД_Контрагента", "ИД_Менеджера")
);

CREATE TABLE "Банки" (
    "ИД_Банка" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Адрес" VARCHAR(255)
);

CREATE TABLE "Группы" (
    "ИД_Группы" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Комментарии" TEXT
);

CREATE TABLE "Товары" (
    "ИД_Товара" SERIAL PRIMARY KEY,
    "ИД_Группы" INT REFERENCES "Группы"("ИД_Группы"),
    "Название" VARCHAR(100),
    "Описание" TEXT,
    "Срок_годности" INT
);

CREATE TABLE "Валюты" (
    "ИД_Валюты" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Сокращение" VARCHAR(10)
);

CREATE TABLE "Цены" (
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    "ИД_Валюты" INT REFERENCES "Валюты"("ИД_Валюты"),
    "Значение" DECIMAL(10,2),
    PRIMARY KEY ("ИД_Товара", "Дата_Начала", "ИД_Валюты")
);


CREATE TABLE "Курсы" (
    "ИД_Валюты_От" INT REFERENCES "Валюты"("ИД_Валюты"),
    "ИД_Валюты_К" INT REFERENCES "Валюты"("ИД_Валюты"),
    "Дата_Начала" DATE,
    "Дата_Окончания" DATE,
    "Значение" DECIMAL(10,2),
    PRIMARY KEY ("ИД_Валюты_От", "ИД_Валюты_К", "Дата_Начала")
);

CREATE TABLE "Налоги" (
    "ИД_Налога" SERIAL PRIMARY KEY,
    "Название" VARCHAR(100),
    "Значение" DECIMAL(5,2),
    "Комментарии" TEXT
);

CREATE TABLE "Сделки_Покупки" (
    "ИД_Сделки" SERIAL PRIMARY KEY,
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата" DATE,
    "Количество" INT,
    "Стоимость" DECIMAL(10,2),
    "ИД_Налога" INT REFERENCES "Налоги"("ИД_Налога")
);

CREATE TABLE "Сделки_Продажи" (
    "ИД_Сделки" SERIAL PRIMARY KEY,
    "ИД_Товара" INT REFERENCES "Товары"("ИД_Товара"),
    "ИД_Контрагента" INT REFERENCES "Контрагенты"("ИД_Контрагента"),
    "ИД_Менеджера" INT REFERENCES "Менеджеры"("ИД_Менеджера"),
    "Дата" DATE,
    "Количество" INT,
    "Стоимость" DECIMAL(10,2),
    "ИД_Налога" INT REFERENCES "Налоги"("ИД_Налога")
);

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 1', 5.00, 'Комментарий о дилере 1'),
('Дилер 2', 6.00, 'Комментарий о дилере 2'),
('Дилер 3', 7.00, 'Комментарий о дилере 3'),
('Дилер 4', 8.00, 'Комментарий о дилере 4'),
('Дилер 5', 9.00, 'Комментарий о дилере 5');

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 6', 5.00, 'Комментарий о дилере 6'),
('Дилер 7', 4.50, 'Комментарий о дилере 7'),
('Дилер 8', 6.00, 'Комментарий о дилере 8');

INSERT INTO "Дилеры" ("Название", "Процент", "Комментарии") VALUES
('Дилер 9', 3.00, 'Комментарий о дилере 9'),
('Дилер 10', 2.50, 'Комментарий о дилере 10'),
('Дилер 11', 4.00, 'Комментарий о дилере 11');


INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(1, 'Менеджер 1', 10.00, '2024-01-01', 'Комментарий о менеджере 1', NULL),
(1, 'Менеджер 2', 11.00, '2024-02-01', 'Комментарий о менеджере 2', NULL),
(2, 'Менеджер 3', 12.00, '2024-03-01', 'Комментарий о менеджере 3', NULL),
(3, 'Менеджер 4', 13.00, '2024-04-01', 'Комментарий о менеджере 4', NULL),
(4, 'Менеджер 5', 14.00, '2024-05-01', 'Комментарий о менеджере 5', NULL);

INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(6, 'Менеджер 1', 12.00, '2024-05-01', 'Комментарий о менеджере 6', 1),
(7, 'Менеджер 2', 10.00, '2024-05-02', 'Комментарий о менеджере 7', 3),
(8, 'Менеджер 3', 7.00, '2024-05-02', 'Комментарий о менеджере 8', 4);

INSERT INTO "Менеджеры" ("ИД_Дилера", "Имя", "Процент", "Дата_найма", "Комментарии", "ИД_Родителя") VALUES
(9, 'Менеджер 1', 4.00, '2024-05-03', 'Комментарий о менеджере 9', 3),
(10, 'Менеджер 2', 3.75, '2024-05-03', 'Комментарий о менеджере 10', 3),
(11, 'Менеджер 3', 2.30, '2024-05-03', 'Комментарий о менеджере 11', 4);

INSERT INTO "Контрагенты" ("Название", "Адрес", "Телефон", "Комментарии") VALUES
('Контрагент 1', 'Адрес контрагента 1', '111-111', 'Комментарий о контрагенте 1'),
('Контрагент 2', 'Адрес контрагента 2', '222-222', 'Комментарий о контрагенте 2'),
('Контрагент 3', 'Адрес контрагента 3', '333-333', 'Комментарий о контрагенте 3'),
('Контрагент 4', 'Адрес контрагента 4', '444-444', 'Комментарий о контрагенте 4');

INSERT INTO "Контракты" ("ИД_Контрагента", "ИД_Менеджера", "Дата_Начала", "Дата_Окончания") VALUES
(1, 1, '2024-01-01', '2024-12-31'),
(2, 2, '2024-02-01', '2024-12-31'),
(3, 3, '2024-03-01', '2024-12-31'),
(4, 4, '2024-04-01', '2024-12-31');

INSERT INTO "Банки" ("Название", "Адрес") VALUES
('Банк 1', 'Адрес банка 1'),
('Банк 2', 'Адрес банка 2'),
('Банк 3', 'Адрес банка 3');

INSERT INTO "Группы" ("Название", "Комментарии") VALUES
('Группа 1', 'Комментарий о группе 1'),
('Группа 2', 'Комментарий о группе 2'),
('Группа 3', 'Комментарий о группе 3');

INSERT INTO "Валюты" ("Название", "Сокращение") VALUES
('Рубли', 'RUB'),
('Доллары', 'USD'),
('Евро', 'EUR');

INSERT INTO "Товары" ("ИД_Группы", "Название", "Описание", "Срок_годности") VALUES
(1, 'Товар 1', 'Описание товара 1', 365),
(2, 'Товар 2', 'Описание товара 2', 180),
(3, 'Товар 3', 'Описание товара 3', 90),
(1, 'Товар 4', 'Описание товара 4', 365),
(2, 'Товар 5', 'Описание товара 5', 180),
(3, 'Товар 6', 'Описание товара 6', 90),
(1, 'Товар 7', 'Описание товара 7', 365),
(2, 'Товар 8', 'Описание товара 8', 180),
(3, 'Товар 9', 'Описание товара 9', 90),
(1, 'Товар 10', 'Описание товара 10', 365),
(2, 'Товар 11', 'Описание товара 11', 180),
(3, 'Товар 12', 'Описание товара 12', 90),
(1, 'Товар 13', 'Описание товара 13', 365),
(2, 'Товар 14', 'Описание товара 14', 180),
(3, 'Товар 15', 'Описание товара 15', 90);

INSERT INTO "Цены" ("ИД_Товара", "Дата_Начала", "Дата_Окончания", "ИД_Валюты", "Значение") VALUES
(1, '2024-01-01', '2024-12-31', 1, 100),
(2, '2024-01-01', '2024-12-31', 1, 200),
(3, '2024-01-01', '2024-12-31', 1, 300),
(4, '2024-01-01', '2024-12-31', 1, 400),
(5, '2024-01-01', '2024-12-31', 1, 500),
(6, '2024-01-01', '2024-12-31', 1, 600),
(7, '2024-01-01', '2024-12-31', 1, 700),
(8, '2024-01-01', '2024-12-31', 1, 800),
(9, '2024-01-01', '2024-12-31', 1, 900),
(10, '2024-01-01', '2024-12-31', 1, 1000),
(11, '2024-01-01', '2024-12-31', 1, 1100),
(12, '2024-01-01', '2024-12-31', 1, 1200),
(13, '2024-01-01', '2024-12-31', 1, 1300),
(14, '2024-01-01', '2024-12-31', 1, 1400),
(15, '2024-01-01', '2024-12-31', 1, 1500);

INSERT INTO "Курсы" ("ИД_Валюты_От", "ИД_Валюты_К", "Дата_Начала", "Дата_Окончания", "Значение") VALUES
(1, 2, '2024-01-01', '2024-12-31', 0.013), -- Курс рубля к доллару
(1, 3, '2024-01-01', '2024-12-31', 0.012); -- Курс рубля к евро

ALTER TABLE "Контракты"
ADD CONSTRAINT "FK_Контракты_Менеджеры"
FOREIGN KEY ("ИД_Менеджера")
REFERENCES "Менеджеры" ("ИД_Менеджера");


DO $$
DECLARE
    rec RECORD;
    cur CURSOR FOR
    SELECT
        t."ИД_Товара",
        t."Название" AS "Название_Товара",
        g."Название" AS "Название_Группы",
        c."Значение" AS "Стоимость_В_Рублях"
    FROM
        "Товары" t
    JOIN
        "Группы" g ON t."ИД_Группы" = g."ИД_Группы"
    JOIN
        "Цены" c ON t."ИД_Товара" = c."ИД_Товара"
    WHERE
        c."ИД_Валюты" = 1
        AND c."Дата_Начала" <= CURRENT_DATE
        AND c."Дата_Окончания" >= CURRENT_DATE;
BEGIN
    OPEN cur;

    LOOP
        FETCH cur INTO rec;
        EXIT WHEN NOT FOUND;
        RAISE NOTICE 'ID: %, Название товара: %, Название группы: %, Стоимость в рублях: %',
            rec."ИД_Товара", rec."Название_Товара", rec."Название_Группы", rec."Стоимость_В_Рублях";
    END LOOP;

    CLOSE cur;
END $$;


DO $$
DECLARE
    rec RECORD;
    cur CURSOR (group_id INT) FOR
    SELECT
        t."ИД_Товара",
        t."Название" AS "Название_Товара",
        g."Название" AS "Название_Группы",
        c."Значение" AS "Стоимость_В_Рублях"
    FROM
        "Товары" t
    JOIN
        "Группы" g ON t."ИД_Группы" = g."ИД_Группы"
    JOIN
        "Цены" c ON t."ИД_Товара" = c."ИД_Товара"
    WHERE
        t."ИД_Группы" = group_id
        AND c."ИД_Валюты" = 1
        AND c."Дата_Начала" <= CURRENT_DATE
        AND c."Дата_Окончания" >= CURRENT_DATE;

BEGIN
    OPEN cur(1);

    LOOP
        FETCH cur INTO rec;
        EXIT WHEN NOT FOUND;
        RAISE NOTICE 'ID: %, Название товара: %, Название группы: %, Стоимость в рублях: %',
            rec."ИД_Товара", rec."Название_Товара", rec."Название_Группы", rec."Стоимость_В_Рублях";
    END LOOP;

    CLOSE cur;
END $$;








--Неявные курсоры
--13.1
DO $$
DECLARE
    m INTEGER;
BEGIN
    SELECT COUNT(ca."ИД_Контрагента") INTO m
    FROM "Контрагенты" ca
    JOIN "Контракты" c ON c."ИД_Контрагента" = ca."ИД_Контрагента"
    WHERE c."Дата_Начала" >= current_date - INTERVAL '6 months';

    RAISE NOTICE 'кол-во контрагентов = %', m;
END $$;


--13.2
DO $$
DECLARE
    c_id INTEGER;
    start_date DATE;
    end_date DATE;
    contract_duration INTERVAL;
    min_duration INTERVAL := INTERVAL '6 months';
    target_year INTEGER := 2023;
BEGIN
    FOR c_id, start_date, end_date IN
        SELECT c."ИД_Контрагента", c."Дата_Начала", c."Дата_Окончания"
        FROM "Контракты" c
        WHERE EXTRACT(YEAR FROM c."Дата_Начала") = target_year
    LOOP
        contract_duration := end_date - start_date;

        if contract_duration >= min_duration then
            update "Контрагенты"
            set "Комментарии" = 'Контракт продолжительности ' || contract_duration
            where "ИД_Контрагента" = c_id;
        end if;
    end loop;
END $$;









